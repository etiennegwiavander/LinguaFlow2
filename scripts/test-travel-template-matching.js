require('dotenv').config({ path: '.env.local' });
const { createClient } = require('@supabase/supabase-js');

const supabaseUrl = process.env.NEXT_PUBLIC_SUPABASE_URL;
const supabaseKey = process.env.SUPABASE_SERVICE_ROLE_KEY;

if (!supabaseUrl || !supabaseKey) {
  console.error('‚ùå Missing Supabase credentials');
  process.exit(1);
}

const supabase = createClient(supabaseUrl, supabaseKey);

async function testTemplateMatching() {
  console.log('üß™ Testing English for Travel Template Matching\n');
  console.log('This simulates what happens when generating interactive materials\n');

  // Simulate a subtopic generated by AI (like in the screenshot)
  const mockSubTopic = {
    id: "subtopic_test",
    title: "Present Perfect for Unfinished American Adventures",
    category: "English for Travel",  // This is what the AI generates
    level: "b2",
    description: "Using present perfect tense to describe ongoing travel experiences"
  };

  console.log('üìã Mock Subtopic (AI-generated):');
  console.log(`   Title: ${mockSubTopic.title}`);
  console.log(`   Category: "${mockSubTopic.category}"`);
  console.log(`   Level: ${mockSubTopic.level.toUpperCase()}\n`);

  // Fetch all templates
  const { data: templates, error } = await supabase
    .from('lesson_templates')
    .select('*')
    .eq('is_active', true);

  if (error) {
    console.error('‚ùå Error fetching templates:', error);
    return;
  }

  console.log(`üìö Total templates in database: ${templates.length}\n`);

  // Step 1: Try exact match (level + category)
  console.log('üîç Step 1: Looking for exact match (level + category)...');
  const exactMatches = templates.filter(
    (t) => t.level === mockSubTopic.level && t.category === mockSubTopic.category
  );

  if (exactMatches.length > 0) {
    console.log(`   ‚úÖ Found ${exactMatches.length} exact match(es):`);
    exactMatches.forEach(t => {
      console.log(`      - ${t.name} (${t.category}, ${t.level.toUpperCase()})`);
    });
    console.log('\n   üéâ SUCCESS! Template matching will work correctly!');
    console.log('   The "Invalid Template Structure" error is fixed.\n');
    
    // Show what would happen
    console.log('üìù What happens next:');
    console.log('   1. System finds matching template ‚úÖ');
    console.log('   2. AI generates personalized content using template structure');
    console.log('   3. Interactive material displays correctly');
    console.log('   4. No "Invalid Template Structure" error');
    
    return;
  }

  console.log('   ‚ùå No exact matches found\n');

  // Step 2: Try category-only match
  console.log('üîç Step 2: Looking for category-only match...');
  const categoryMatches = templates.filter(
    (t) => t.category === mockSubTopic.category
  );

  if (categoryMatches.length > 0) {
    console.log(`   ‚ö†Ô∏è  Found ${categoryMatches.length} category match(es) (different levels):`);
    categoryMatches.forEach(t => {
      console.log(`      - ${t.name} (${t.category}, ${t.level.toUpperCase()})`);
    });
    console.log('\n   ‚ö†Ô∏è  Would use fallback template (not ideal but works)\n');
  } else {
    console.log('   ‚ùå No category matches found\n');
  }

  // Step 3: Show what categories exist
  console.log('üìä Available categories in database:');
  const categories = [...new Set(templates.map(t => t.category))].sort();
  categories.forEach(cat => {
    const count = templates.filter(t => t.category === cat).length;
    console.log(`   - "${cat}" (${count} templates)`);
  });

  console.log('\n‚ùå PROBLEM: No matching template found!');
  console.log('   This would cause "Invalid Template Structure" error');
}

testTemplateMatching();
